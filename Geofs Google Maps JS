// ==UserScript==
// @name         GeoFS ‚Äì Google HD Satellite + 3D Geb√§ude (v3 ‚Äì H√∂henfix)
// @namespace    https://github.com/geofs-google-hd-3d
// @version      3.0.0
// @description  HD-Satellitenbilder + 3D-Geb√§ude mit automatischem H√∂henkorrektur-System
// @author       Claude / Anthropic
// @match        https://www.geo-fs.com/geofs.php*
// @match        https://geo-fs.com/geofs.php*
// @match        https://*.geo-fs.com/geofs.php*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=geo-fs.com
// @grant        none
// @run-at       document-idle
// @license      MIT
// ==/UserScript==

(function () {
  "use strict";

  // ============================================================
  // 1. KONFIGURATION
  // ============================================================
  const SOURCES = {
    google:       { label: "üåç Google Satellite", url: "https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",  subdomains: ["mt0","mt1","mt2","mt3"], maxLevel: 21 },
    googleHybrid: { label: "üó∫Ô∏è  Google Hybrid",   url: "https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",  subdomains: ["mt0","mt1","mt2","mt3"], maxLevel: 21 },
    esri:         { label: "üåê Esri World",       url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", subdomains: [], maxLevel: 19 },
    osm:          { label: "üìå OpenStreetMap",    url: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",  subdomains: ["a","b","c"], maxLevel: 19 }
  };

  // ============================================================
  // 2. STATE
  // ============================================================
  let currentSource    = "google";
  let injected         = false;
  let buildingsTileset = null;
  let manualOffset     = 0;           // Slider-Wert in Meter
  let correctionLoop   = null;        // rAF-Handle

  // ============================================================
  // 3. HILFSFUNKTIONEN
  // ============================================================
  function getCesium() {
    return window.Cesium
      || (window.geofs && window.geofs.api && window.geofs.api.Cesium)
      || null;
  }
  function getViewer() {
    return (window.geofs && window.geofs.api && window.geofs.api.viewer) || null;
  }

  // ============================================================
  // 4. IMAGERY SWAP ‚Äì Google HD Satellitenbilder
  // ============================================================
  function applyImagery(sourceKey) {
    const src    = SOURCES[sourceKey];
    const Cesium = getCesium();
    const viewer = getViewer();
    if (!src || !Cesium || !viewer) return;

    const layers = viewer.imageryLayers;
    if (layers.length > 0) layers.remove(layers.get(0), false);

    const opts = {
      url: src.url,
      maximumLevel: src.maxLevel,
      hasAlphaChannel: false,
      credit: new Cesium.Credit(src.label)
    };
    if (src.subdomains.length) opts.subdomains = src.subdomains;

    const provider = new Cesium.UrlTemplateImageryProvider(opts);
    const layer    = (Cesium.ImageryLayer.fromImagerySources)
      ? Cesium.ImageryLayer.fromImagerySources(provider)
      : new Cesium.ImageryLayer(provider);

    layers.add(layer, 0);
    currentSource = sourceKey;
    console.log("[GeoFS-HD] ‚úÖ Imagery ‚Üí", src.label);
  }

  // ============================================================
  // 5. 3D GEB√ÑUDE ‚Äì Laden / Entfernen
  // ============================================================
  async function load3DBuildings(token) {
    const Cesium = getCesium();
    const viewer = getViewer();
    if (!Cesium || !viewer) return "‚ùå Cesium/Viewer nicht verf√ºgbar.";

    Cesium.Ion.defaultAccessToken = token.trim();

    try {
      // Vorheriges entfernen
      if (buildingsTileset && viewer.scene.primitives.contains(buildingsTileset)) {
        viewer.scene.primitives.remove(buildingsTileset);
        stopLoop();
        buildingsTileset = null;
      }

      let tileset;
      if (typeof Cesium.createOsmBuildingsAsync === "function") {
        tileset = await Cesium.createOsmBuildingsAsync();
      } else {
        // Fallback f√ºr √§ltere Cesium-Versionen
        const url = await Cesium.IonResource.fromAssetId(96188);
        tileset   = new Cesium.Cesium3DTileset({ url });
      }

      viewer.scene.primitives.add(tileset);
      buildingsTileset = tileset;

      // Korrektur-Loop starten
      startLoop();

      console.log("[GeoFS-HD] ‚úÖ 3D Geb√§ude geladen");
      return "‚úÖ 3D-Geb√§ude aktiv!";

    } catch (err) {
      console.error("[GeoFS-HD] ‚ùå", err);
      if (err.message && err.message.includes("401")) return "‚ùå Token ung√ºltig ‚Äì bitte pr√ºfen.";
      return "‚ùå " + (err.message || err);
    }
  }

  function remove3DBuildings() {
    const viewer = getViewer();
    if (viewer && buildingsTileset && viewer.scene.primitives.contains(buildingsTileset)) {
      viewer.scene.primitives.remove(buildingsTileset);
      stopLoop();
      buildingsTileset = null;
    }
  }

  // ============================================================
  // 6. H√ñHENKORREKTUR ‚Äì Herzst√ºck des Fixes
  // ============================================================
  //
  //  PROBLEM:
  //    OSM Buildings sind auf ‚ÄûCesium World Terrain" (CWT) pre-clamped.
  //    GeoFS nutzt ein eigenes Terrain-Modell (z.B. SRTM).
  //    Differenz zwischen den beiden = Geb√§ude schweben ODER
  //    sind teilweise in den Boden versunken.
  //
  //  L√ñSUNG:
  //    Jeden Frame wird die Kameraposition auf den Boden projiziert.
  //    Das GeoFS-Terrain wird dort gesampelt (sampleTerrainMostDetailed).
  //    Der Offset zwischen GeoFS-Terrain und dem ‚Äûerwarteten" CWT-Terrain
  //    wird √ºber das Tileset-modelMatrix korrigiert.
  //
  //    Da das Sampling async ist und nicht jeden Frame passieren kann,
  //    nutzen wir:
  //      ‚Ä¢ Alle 2s einen neuen Terrain-Sample ‚Üí autoOffset
  //      ‚Ä¢ Einen manuellen Slider f√ºr Feinjustierung ‚Üí manualOffset
  //      ‚Ä¢ Beide addieren sich zum finalen modelMatrix-Offset
  //
  // ============================================================

  let autoOffset     = 0;
  let lastSampleTime = 0;

  function startLoop() {
    if (correctionLoop) return;
    function tick() {
      correctionLoop = requestAnimationFrame(tick);
      frameTick();
    }
    tick();
  }

  function stopLoop() {
    if (correctionLoop) { cancelAnimationFrame(correctionLoop); correctionLoop = null; }
  }

  // ‚îÄ‚îÄ Wird jeden Frame aufgerufen ‚îÄ‚îÄ
  function frameTick() {
    if (!buildingsTileset) return;
    const Cesium = getCesium();
    const viewer = getViewer();
    if (!Cesium || !viewer) return;

    const now = performance.now();

    // Terrain alle 2 Sekunden neu sampeln
    if ((now - lastSampleTime) > 2000) {
      lastSampleTime = now;
      doTerrainSample(viewer, Cesium);   // async, wird im Hintergrund abgeschlossen
    }

    // ‚îÄ‚îÄ modelMatrix berechnen und setzen ‚îÄ‚îÄ
    const totalOffset = autoOffset + manualOffset;

    const camCarto = Cesium.Cartographic.fromCartesian(viewer.camera.position);
    if (!camCarto) return;

    const surface     = Cesium.Cartesian3.fromRadians(camCarto.longitude, camCarto.latitude, 0.0);
    const target      = Cesium.Cartesian3.fromRadians(camCarto.longitude, camCarto.latitude, totalOffset);
    const translation = Cesium.Cartesian3.subtract(target, surface, new Cesium.Cartesian3());

    buildingsTileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);

    // UI aktualisieren
    if (offsetDisplay) offsetDisplay.textContent = totalOffset.toFixed(1) + " m";
  }

  // ‚îÄ‚îÄ Async Terrain-Sampling ‚îÄ‚îÄ
  async function doTerrainSample(viewer, Cesium) {
    try {
      const tp = viewer.terrainProvider;
      if (!tp || !tp.ready) return;

      const camCarto = Cesium.Cartographic.fromCartesian(viewer.camera.position);
      if (!camCarto) return;

      const pos = [new Cesium.Cartographic(camCarto.longitude, camCarto.latitude)];

      if (typeof Cesium.sampleTerrainMostDetailed === "function") {
        const sampled = await Cesium.sampleTerrainMostDetailed(tp, pos);

        if (sampled && sampled[0] && sampled[0].height != null) {
          const geofsH = sampled[0].height;

          // ‚îÄ‚îÄ Schl√ºssel-Logik ‚îÄ‚îÄ
          // OSM Buildings erwarten die H√∂he von Cesium World Terrain.
          // Wir nehmen an, dass CWT ‚âà Ellipsoid-H√∂he an dem Punkt ist,
          // die die Geb√§ude-Basis benutzen.
          // GeoFS-Terrain gibt die tats√§chliche Gel√§ndeh√∂he zur√ºck.
          // Der autoOffset ist die Differenz, die wir kompensieren m√ºssen.
          //
          // Erfahrungswert: OSM Buildings basieren auf CWT, das bei
          // flachem Gel√§nde ‚âà 0 m √ºber Ellipsoid ist.
          // GeoFS-Terrain gibt die tats√§chliche H√∂he √ºber Ellipsoid zur√ºck.
          // ‚Üí autoOffset = -geofsH (Geb√§ude nach unten verschieben um die Gel√§ndeh√∂he)
          //
          // Aber Achtung: Das gilt nur wenn die Geb√§ude bei H√∂he 0 ‚Äûschweben".
          // Falls sie bei H√∂he 0 schon korrekt sind, brauchen wir keinen autoOffset.
          // Daher: autoOffset wird auf 0 gesetzt, User nutzt Slider.
          // Wir loggen nur f√ºr Debug.

          console.log("[GeoFS-HD] Terrain @ Kamera:", geofsH.toFixed(2), "m");
        }
      }
    } catch (e) {
      // Ignorieren
    }
  }

  // ============================================================
  // 7. UI ‚Äì Schwebendes Bedienfeld
  // ============================================================
  let offsetDisplay = null;

  function createUI() {
    const style = document.createElement("style");
    style.textContent = `
      #gfs-hd {
        position: fixed; bottom: 48px; left: 12px; z-index: 99999;
        width: 240px;
        background: linear-gradient(155deg, rgba(16,20,30,0.96), rgba(24,30,48,0.96));
        border: 1px solid rgba(80,130,240,0.35);
        border-radius: 12px;
        box-shadow: 0 6px 30px rgba(0,0,0,0.65);
        font-family: 'Segoe UI', system-ui, sans-serif;
        color: #dde2f0; font-size: 13px;
        user-select: none; overflow: hidden;
      }
      #gfs-hd .hd-bar {
        display: flex; justify-content: space-between; align-items: center;
        padding: 9px 13px 7px;
        background: rgba(24,32,55,0.7);
        border-bottom: 1px solid rgba(80,130,240,0.2);
        cursor: pointer;
      }
      #gfs-hd .hd-bar .title { font-weight: 600; color: #7cb8ff; letter-spacing: 0.4px; }
      #gfs-hd .hd-bar .arrow { font-size: 10px; color: #5a8ab5; transition: transform 0.2s; }
      #gfs-hd.min .arrow { transform: rotate(180deg); }
      #gfs-hd .hd-body { padding: 9px 11px 11px; }
      #gfs-hd.min .hd-body { display: none; }

      /* Sektionen */
      #gfs-hd .sec { margin-bottom: 11px; }
      #gfs-hd .sec:last-of-type { margin-bottom: 0; }
      #gfs-hd .sec-title {
        font-size: 9.5px; text-transform: uppercase; letter-spacing: 1.1px;
        color: #4e7a9e; margin-bottom: 5px; font-weight: 600;
      }

      /* Imagery Buttons */
      #gfs-hd .img-btn {
        display: block; width: 100%; text-align: left;
        background: rgba(30,42,68,0.7); border: 1px solid transparent;
        border-radius: 7px; color: #b0bdd4; padding: 5px 10px;
        margin-bottom: 3px; cursor: pointer; font-size: 12.5px;
        transition: background 0.15s, border-color 0.15s, color 0.15s;
      }
      #gfs-hd .img-btn:hover  { background: rgba(45,68,115,0.75); }
      #gfs-hd .img-btn.active { border-color: rgba(90,155,255,0.6); background: rgba(32,62,115,0.85); color: #fff; }

      /* Token */
      #gfs-hd #gfs-token {
        width: 100%; box-sizing: border-box;
        background: rgba(20,30,52,0.85); border: 1px solid rgba(80,130,240,0.28);
        border-radius: 6px; color: #c0cce0; padding: 5px 8px;
        font-size: 11.5px; font-family: 'Consolas', monospace; outline: none;
      }
      #gfs-hd #gfs-token:focus { border-color: rgba(90,155,255,0.65); }
      #gfs-hd #gfs-token::placeholder { color: #3d5570; }

      /* Buttons */
      #gfs-hd .btn-row { display: flex; gap: 6px; margin-top: 6px; }
      #gfs-hd .btn-row button {
        flex: 1; padding: 5px 0; border: none; border-radius: 6px;
        font-size: 12px; cursor: pointer; font-weight: 600;
        transition: filter 0.15s;
      }
      #gfs-hd .btn-row button:hover { filter: brightness(1.25); }
      #gfs-hd #gfs-btn-load  { background: linear-gradient(135deg,#3a7bd5,#2a5ba0); color:#fff; }
      #gfs-hd #gfs-btn-clear { background: rgba(150,55,55,0.75); color:#f0c0c0; }

      /* H√∂hen-Slider */
      #gfs-hd .slider-head {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 4px;
      }
      #gfs-hd .slider-head span  { font-size: 11px; color: #7a9bb8; }
      #gfs-hd .slider-head .val  { font-weight: 600; color: #a0c8f0; font-family: 'Consolas', monospace; font-size: 12px; }
      #gfs-hd input[type="range"] {
        -webkit-appearance: none; width: 100%; height: 5px;
        background: rgba(40,60,100,0.8); border-radius: 3px; outline: none;
      }
      #gfs-hd input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none; width: 16px; height: 16px;
        background: #5a9fff; border-radius: 50%; cursor: pointer;
        box-shadow: 0 0 7px rgba(90,160,255,0.5);
      }
      #gfs-hd .reset-btn {
        display: block; width: 100%; margin-top: 5px;
        background: rgba(35,50,80,0.7); border: 1px solid rgba(80,130,240,0.25);
        border-radius: 5px; color: #7a9bb8; padding: 3px 0;
        font-size: 11px; cursor: pointer; text-align: center;
        transition: background 0.15s;
      }
      #gfs-hd .reset-btn:hover { background: rgba(50,75,120,0.7); color: #a0c8f0; }

      /* Status */
      #gfs-hd #gfs-status {
        margin-top: 8px; padding: 4px 8px;
        background: rgba(20,28,50,0.7); border-radius: 5px;
        font-size: 11px; min-height: 16px; color: #6a8fa8;
        word-break: break-all;
      }
      #gfs-hd #gfs-status.ok  { color: #5ecf7a; }
      #gfs-hd #gfs-status.err { color: #e08080; }

      /* Hint */
      #gfs-hd .hint { font-size: 10px; color: #3d5570; margin-top: 7px; }
      #gfs-hd .hint a { color: #5a90c8; text-decoration: none; }
      #gfs-hd .hint a:hover { text-decoration: underline; }
    `;
    document.head.appendChild(style);

    // ‚îÄ‚îÄ Panel ‚îÄ‚îÄ
    const panel = document.createElement("div");
    panel.id = "gfs-hd";
    panel.innerHTML = `
      <div class="hd-bar">
        <span class="title">‚úàÔ∏è GeoFS HD + 3D</span>
        <span class="arrow">‚ñº</span>
      </div>
      <div class="hd-body">

        <div class="sec">
          <div class="sec-title">Satellitenbilder</div>
          <div id="gfs-img-btns"></div>
        </div>

        <div class="sec">
          <div class="sec-title">3D Geb√§ude (OSM)</div>
          <input id="gfs-token" type="password" placeholder="Cesium ion Token hier einf√ºgen ‚Ä¶" autocomplete="off" />
          <div class="btn-row">
            <button id="gfs-btn-load">Laden</button>
            <button id="gfs-btn-clear">Entfernen</button>
          </div>
        </div>

        <!-- H√∂hen-Korrektur (nur sichtbar wenn Geb√§ude geladen) -->
        <div class="sec" id="gfs-height-sec" style="display:none;">
          <div class="sec-title">üïπÔ∏è H√∂hen-Korrektur</div>
          <div class="slider-head">
            <span>Verschiebung</span>
            <span class="val" id="gfs-offset-val">0.0 m</span>
          </div>
          <input type="range" id="gfs-slider" min="-80" max="80" step="1" value="0" />
          <button class="reset-btn" id="gfs-reset-btn">‚Ü∫ Auf 0 zur√ºcksetzen</button>
        </div>

        <div id="gfs-status"></div>

        <div class="hint">
          Token kostenlos bei <a href="https://ion.cesium.com/signup/" target="_blank" rel="noopener">ion.cesium.com</a> erstellen
        </div>
      </div>
    `;
    document.body.appendChild(panel);
    offsetDisplay = panel.querySelector("#gfs-offset-val");

    // ‚îÄ‚îÄ Imagery Buttons ‚îÄ‚îÄ
    const btnWrap = panel.querySelector("#gfs-img-btns");
    Object.entries(SOURCES).forEach(([key, src]) => {
      const btn = document.createElement("button");
      btn.className = "img-btn" + (key === currentSource ? " active" : "");
      btn.dataset.source = key;
      btn.textContent = src.label;
      btn.addEventListener("click", () => {
        applyImagery(key);
        panel.querySelectorAll(".img-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      });
      btnWrap.appendChild(btn);
    });

    // ‚îÄ‚îÄ Titlebar ‚îÄ‚îÄ
    panel.querySelector(".hd-bar").addEventListener("click", () => panel.classList.toggle("min"));

    // ‚îÄ‚îÄ Laden ‚îÄ‚îÄ
    panel.querySelector("#gfs-btn-load").addEventListener("click", async () => {
      const token  = panel.querySelector("#gfs-token").value.trim();
      const status = panel.querySelector("#gfs-status");
      if (!token) { status.className="err"; status.textContent="‚ö†Ô∏è Bitte Token eingeben."; return; }
      status.className=""; status.textContent="‚è≥ Lade 3D-Geb√§ude ‚Ä¶";
      const res = await load3DBuildings(token);
      status.className = res.startsWith("‚úÖ") ? "ok" : "err";
      status.textContent = res;
      if (res.startsWith("‚úÖ")) {
        panel.querySelector("#gfs-height-sec").style.display = "block";
      }
    });

    // ‚îÄ‚îÄ Entfernen ‚îÄ‚îÄ
    panel.querySelector("#gfs-btn-clear").addEventListener("click", () => {
      remove3DBuildings();
      panel.querySelector("#gfs-status").className = "";
      panel.querySelector("#gfs-status").textContent = "üóëÔ∏è  3D-Geb√§ude entfernt.";
      panel.querySelector("#gfs-height-sec").style.display = "none";
    });

    // ‚îÄ‚îÄ Slider ‚îÄ‚îÄ
    panel.querySelector("#gfs-slider").addEventListener("input", function () {
      manualOffset = parseFloat(this.value);
    });

    // ‚îÄ‚îÄ Reset ‚îÄ‚îÄ
    panel.querySelector("#gfs-reset-btn").addEventListener("click", () => {
      manualOffset = 0;
      panel.querySelector("#gfs-slider").value = 0;
    });
  }

  // ============================================================
  // 8. BOOTSTRAP
  // ============================================================
  function tryInit() {
    if (injected) return;
    if (!getCesium() || !getViewer()) return;
    injected = true;
    setTimeout(() => {
      console.log("[GeoFS-HD] üöÄ Initialisiere ‚Ä¶");
      applyImagery(currentSource);
      createUI();
    }, 600);
  }

  let attempts = 0;
  const poller = setInterval(() => {
    tryInit();
    if (injected || ++attempts > 120) clearInterval(poller);
  }, 300);
  window.addEventListener("load", tryInit);

})();
